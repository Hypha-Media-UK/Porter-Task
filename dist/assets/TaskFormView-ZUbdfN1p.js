import{a as de,c as h,r as S,w as V,g as re,i as Q,b as d,e as i,t as g,z as k,G as U,D as A,A as L,F as j,B as D,f as P,o as r}from"./vendor-DszYqHt7.js";import{u as ue,a as ce}from"./index-DlOD_Yz9.js";const me={class:"task-form-view"},ve={class:"form-container"},fe={class:"task-form"},pe={class:"form-group time-received"},ge={class:"form-grid"},Te={class:"form-section job-type"},ye={class:"form-group"},be=["value"],ke={class:"form-group job-item"},he=["value"],we={class:"form-section"},Ie={class:"form-group from-section"},Se=["value"],Ce={key:0,class:"building-info"},Le={class:"form-group to-section"},je=["value"],De={key:0,class:"building-info"},Ne={class:"form-section"},Be={class:"form-group porter-section"},Me=["value"],xe={class:"form-group time-allocated"},Ve={class:"form-group time-completed"},Fe=["disabled"],He={class:"form-actions"},Ue=["disabled"],Ae=["disabled"],Ee=de({__name:"TaskFormView",props:{taskId:{}},setup(W){const c=W,m=Q("navigate");Q("route");const w=ue(),N=ce(),{createTask:X,updateTask:Y,deleteTask:Z,getTask:q}=w,ee=h(()=>w.isShiftActive),{jobCategories:E,buildings:B}=N,J=N.porters,te=h(()=>{var t,e;return y.value?J:(e=(t=w.currentShift)==null?void 0:t.assignedPorters)!=null&&e.length?w.currentShift.assignedPorters:J}),T=h(()=>!!c.taskId),y=S(!1),b=S(null),oe=()=>{if(window.location.href.includes("/archive/")){const t=window.location.href.match(/\/archive\/([^/?]+)/);t&&t[1]&&(b.value=t[1],y.value=!0,console.log("Detected editing from archive, shift ID:",b.value))}if(!y.value&&c.taskId&&q(c.taskId)){const e=w.archivedShifts;for(const o of e)if(o.tasks.find(u=>u.id===c.taskId)){b.value=o.id,y.value=!0,console.log("Task belongs to archived shift:",o.id);break}}},_=()=>{const t=new Date;return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},M=t=>{const e=new Date;return e.setMinutes(e.getMinutes()+t),`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},v=S(null),f=S(null),a=S({jobCategory:"",itemType:"",fromLocation:{building:"",locationId:"",locationType:"department",displayName:""},toLocation:{building:"",locationId:"",locationType:"ward",displayName:""},allocatedStaff:"",receivedTime:_(),allocatedTime:M(1),completedTime:M(17)});V(v,t=>{t&&(a.value.fromLocation={building:t.buildingId,locationId:t.id,locationType:t.locationType,displayName:t.name})}),V(f,t=>{t&&(a.value.toLocation={building:t.buildingId,locationId:t.id,locationType:t.locationType,displayName:t.name})});const F=h(()=>a.value.jobCategory&&a.value.itemType&&v.value!==null&&f.value!==null),H=h(()=>Object.keys(E)),$=h(()=>{const t=a.value.jobCategory;return t?E[t]||[]:[]}),p=h(()=>{const t=[];return B.forEach(e=>{e.departments.forEach(o=>{t.push({id:o.id,name:o.name,buildingId:e.id,buildingName:e.name,locationType:"department"})}),e.wards.forEach(o=>{t.push({id:o.id,name:o.name,buildingId:e.id,buildingName:e.name,locationType:"ward"})})}),t.sort((e,o)=>e.name.localeCompare(o.name))}),O=(t,e,o)=>{const n=B.find(s=>s.id===t);if(!n)return;const l=(o==="department"?n.departments:n.wards).find(s=>s.id===e);if(l)return{id:l.id,name:l.name,buildingId:n.id,buildingName:n.name,locationType:o}},ie=()=>{if(!c.taskId)return;const t=q(c.taskId);if(t){if(!y.value){const s=w.archivedShifts;for(const I of s)if(I.tasks.find(x=>x.id===c.taskId)){b.value=I.id,y.value=!0,console.log("Task belongs to archived shift (from loadTask):",I.id);break}}const e=t.receivedTime?new Date(t.receivedTime).toTimeString().substring(0,5):_(),o=t.allocatedTime?new Date(t.allocatedTime).toTimeString().substring(0,5):M(1),n=t.completedTime?new Date(t.completedTime).toTimeString().substring(0,5):M(17);a.value={jobCategory:t.jobCategory,itemType:t.itemType,fromLocation:{...t.fromLocation},toLocation:{...t.toLocation},allocatedStaff:t.allocatedStaff,receivedTime:e,allocatedTime:o,completedTime:n,status:t.status};const u=O(t.fromLocation.building,t.fromLocation.locationId,t.fromLocation.locationType);u&&(v.value=u);const l=O(t.toLocation.building,t.toLocation.locationId,t.toLocation.locationType);l&&(f.value=l)}else m&&m("tasks")},z=()=>{y.value&&b.value?m&&m("shiftDetail",{shiftId:b.value}):m&&m("tasks")},R=(t="Pending")=>{if(!F.value)return;const e=new Date,[o,n]=a.value.receivedTime.split(":").map(Number),[u,l]=a.value.allocatedTime.split(":").map(Number),s=new Date(e);s.setHours(o,n,0,0);const I=new Date(e);I.setHours(u,l,0,0);let C;if(t==="Completed"&&a.value.completedTime){const[le,se]=a.value.completedTime.split(":").map(Number);C=new Date(e),C.setHours(le,se,0,0)}const x={jobCategory:a.value.jobCategory,itemType:a.value.itemType,fromLocation:a.value.fromLocation,toLocation:a.value.toLocation,allocatedStaff:a.value.allocatedStaff,receivedTime:s.toISOString(),allocatedTime:I.toISOString(),completedTime:C?C.toISOString():void 0,status:t};T.value&&c.taskId?Y(c.taskId,x):X(x),z()},ae=()=>{T.value&&c.taskId&&(Z(c.taskId),z())},ne=()=>{y.value&&b.value?m&&m("shiftDetail",{shiftId:b.value}):window.history&&window.history.length>1?window.history.back():m&&m("tasks")};re(()=>{if(oe(),!ee.value&&!c.taskId){m&&m("home");return}if(H.value.length>0&&(a.value.jobCategory=H.value[0]),p.value.length>0){const t=p.value.find(o=>o.locationType==="department")||p.value[0];v.value=t;const e=p.value.find(o=>o.locationType==="ward")||(p.value.length>1?p.value[1]:p.value[0]);f.value=e}T.value&&ie()});const G=t=>{if(t){if(t.fromBuildingId&&t.fromLocationType){const e=t.fromBuildingId,o=t.fromLocationType,n=B.find(u=>u.id===e);if(n&&t.fromLocationId){const l=(o==="department"?n.departments:n.wards).find(s=>s.id===t.fromLocationId);if(l){const s={id:l.id,name:l.name,buildingId:n.id,buildingName:n.name,locationType:o};v.value=s}}}if(t.toBuildingId&&t.toLocationType){const e=t.toBuildingId,o=t.toLocationType,n=B.find(u=>u.id===e);if(n&&t.toLocationId){const l=(o==="department"?n.departments:n.wards).find(s=>s.id===t.toLocationId);if(l){const s={id:l.id,name:l.name,buildingId:n.id,buildingName:n.name,locationType:o};f.value=s}}}}},K=S(!0);return V(()=>a.value.jobCategory,()=>{if(!K.value||!T.value){a.value.itemType="";const t=$.value;t.length>0&&(a.value.itemType=t[0])}if(a.value.jobCategory&&!T.value){const t=N.getJobCategoryDefault(a.value.jobCategory);G(t)}K.value=!1}),V(()=>a.value.itemType,()=>{if(a.value.jobCategory&&a.value.itemType){const t=N.getJobCategoryDefault(a.value.jobCategory,a.value.itemType);t&&G(t)}}),(t,e)=>(r(),d("main",me,[i("div",ve,[i("h1",null,g(T.value?"Edit Task":"New Task"),1),i("form",fe,[i("div",pe,[e[10]||(e[10]=i("label",{for:"receivedTime"},"Time Received",-1)),k(i("input",{type:"time",id:"receivedTime","onUpdate:modelValue":e[0]||(e[0]=o=>a.value.receivedTime=o),class:"form-control",required:""},null,512),[[U,a.value.receivedTime]])]),i("div",ge,[i("div",Te,[e[15]||(e[15]=i("h2",{class:"form-section-title"},[i("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[i("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),i("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]),A(" Job Details ")],-1)),i("div",ye,[e[12]||(e[12]=i("label",{for:"jobCategory"},"Job Type",-1)),k(i("select",{id:"jobCategory","onUpdate:modelValue":e[1]||(e[1]=o=>a.value.jobCategory=o),class:"form-control",required:""},[e[11]||(e[11]=i("option",{value:"",disabled:""},"Select job type",-1)),(r(!0),d(j,null,D(H.value,o=>(r(),d("option",{key:o,value:o},g(o),9,be))),128))],512),[[L,a.value.jobCategory]])]),i("div",ke,[e[14]||(e[14]=i("label",{for:"itemType"},"Job Item",-1)),k(i("select",{id:"itemType","onUpdate:modelValue":e[2]||(e[2]=o=>a.value.itemType=o),class:"form-control",required:""},[e[13]||(e[13]=i("option",{value:"",disabled:""},"Select job item",-1)),(r(!0),d(j,null,D($.value,o=>(r(),d("option",{key:o,value:o},g(o),9,he))),128))],512),[[L,a.value.itemType]])])]),i("div",we,[e[20]||(e[20]=i("h2",{class:"form-section-title"},[i("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[i("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),i("circle",{cx:"12",cy:"10",r:"3"})]),A(" Locations ")],-1)),i("div",Ie,[e[17]||(e[17]=i("h2",null,"From",-1)),k(i("select",{id:"fromLocationId","onUpdate:modelValue":e[3]||(e[3]=o=>v.value=o),class:"form-control",required:""},[e[16]||(e[16]=i("option",{value:"",disabled:""},"Select location",-1)),(r(!0),d(j,null,D(p.value,o=>(r(),d("option",{key:o.id,value:o},g(o.name),9,Se))),128))],512),[[L,v.value]]),v.value?(r(),d("div",Ce," Building: "+g(v.value.buildingName),1)):P("",!0)]),i("div",Le,[e[19]||(e[19]=i("h2",null,"To",-1)),k(i("select",{id:"toLocationId","onUpdate:modelValue":e[4]||(e[4]=o=>f.value=o),class:"form-control",required:""},[e[18]||(e[18]=i("option",{value:"",disabled:""},"Select location",-1)),(r(!0),d(j,null,D(p.value,o=>(r(),d("option",{key:o.id,value:o},g(o.name),9,je))),128))],512),[[L,f.value]]),f.value?(r(),d("div",De," Building: "+g(f.value.buildingName),1)):P("",!0)])]),i("div",Ne,[e[25]||(e[25]=i("h2",{class:"form-section-title"},[i("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[i("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),i("circle",{cx:"12",cy:"7",r:"4"})]),A(" Assignment ")],-1)),i("div",Be,[e[22]||(e[22]=i("h2",null,"Porter Assigned",-1)),k(i("select",{id:"allocatedStaff","onUpdate:modelValue":e[5]||(e[5]=o=>a.value.allocatedStaff=o),class:"form-control porter-select"},[e[21]||(e[21]=i("option",{value:""},"None (Unassigned)",-1)),(r(!0),d(j,null,D(te.value,o=>(r(),d("option",{key:o,value:o},g(o),9,Me))),128))],512),[[L,a.value.allocatedStaff]])]),i("div",xe,[e[23]||(e[23]=i("label",{for:"allocatedTime"},"Time Allocated",-1)),k(i("input",{type:"time",id:"allocatedTime","onUpdate:modelValue":e[6]||(e[6]=o=>a.value.allocatedTime=o),class:"form-control",required:""},null,512),[[U,a.value.allocatedTime]])]),i("div",Ve,[e[24]||(e[24]=i("label",{for:"completedTime"},"Time Completed",-1)),k(i("input",{type:"time",id:"completedTime","onUpdate:modelValue":e[7]||(e[7]=o=>a.value.completedTime=o),class:"form-control",disabled:a.value.status!=="Completed"},null,8,Fe),[[U,a.value.completedTime]])])])]),i("div",He,[i("button",{type:"button",class:"btn-secondary",onClick:ne}," Cancel "),T.value?(r(),d("button",{key:0,type:"button",class:"btn-danger",onClick:ae}," Delete ")):P("",!0),i("button",{type:"button",class:"btn-primary",disabled:!F.value,onClick:e[8]||(e[8]=o=>R("Pending"))}," Mark as Pending ",8,Ue),i("button",{type:"button",class:"btn-success",disabled:!F.value,onClick:e[9]||(e[9]=o=>R("Completed"))},g(T.value?"Update":"Complete Now"),9,Ae)])])])]))}});export{Ee as default};
